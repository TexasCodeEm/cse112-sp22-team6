import*as Constants from"./constants.js";import*as Storage from"./util/storage.js";import{increaseTaskPomo,toggleTaskButtonDisabled}from"./tasks.js";import{updateStats}from"./stats.js";const STOP_TIMER_COLOR="var(--grey)",WORK_TIMER_COLOR="var(--red)",BREAK_TIMER_COLOR="var(--green)",COLORED_POT_SOURCE="images/honey-pot-color.svg",GRAY_POT_SOURCE="images/honey-pot-gray.svg",DASH_STROKE_VAL=220,MINUTES=60,BASE_10=10,FINAL_POMO=4,startStopButton=document.getElementById(Constants.START_STOP_ID),timerRing=document.getElementById("base-timer-path-remaining"),countdownText=document.getElementById("countdownText"),yesButton=document.getElementById("reset-yes-button"),noButton=document.getElementById("reset-no-button"),timerAudio=document.getElementById("timer-sound"),workIndicator=document.getElementById("work-indicator"),longBreakIndicator=document.getElementById("long-break-indicator"),shortBreakIndicator=document.getElementById("short-break-indicator"),timeWorker=window.Worker&&!window.Cypress?new Worker("./scripts/timeWorker.js"):null,HOVER_TEXT="hover-text",BREAK_BUTTON="break-button",HIGHLIGHT="highlight";let pomoCount=0,pomoState=Constants.timerOptions.STOPPED,onBreak=!1,legacyInterval,firstReset=!0;function startResetController(){(pomoState===Constants.timerOptions.STOPPED?startTimer:resetPrompt)()}function beginCountdown(t){displayTime(--t);var e=onBreak?BREAK_TIMER_COLOR:WORK_TIMER_COLOR;timerRing.setAttribute("stroke",e),timerRing.setAttribute("stroke-dasharray",timeFraction(t,pomoState)*DASH_STROKE_VAL+" "+DASH_STROKE_VAL),timeWorker?(timeWorker.onmessage=t=>{pomoState!==Constants.timerOptions.STOPPED&&(t=t.data["timeLeft"],displayTime(t),timerRing.setAttribute("stroke-dasharray",timeFraction(t,pomoState)*DASH_STROKE_VAL+" "+DASH_STROKE_VAL),t<0&&(stopTimer(),hidePrompt(),timeWorker.onmessage=void 0))},e={start:!0,duration:t},timeWorker.postMessage(e)):setCountdownInterval(t)}function setCountdownInterval(t){let e=t;legacyInterval=setInterval(()=>{displayTime(--e),timerRing.setAttribute("stroke-dasharray",timeFraction(e,pomoState)*DASH_STROKE_VAL+" "+DASH_STROKE_VAL),e<0&&(clearInterval(legacyInterval),stopTimer())},1e3)}function togglePomoBreak(t){return startStopButton&&startStopButton.classList.toggle(BREAK_BUTTON),!t}function startTimer(t=onBreak,e=pomoCount){return toggleTaskButtonDisabled(!0),timerAudio.paused||(timerAudio.pause(),timerAudio.currentTime=0),startStopButton&&(startStopButton.innerHTML=Constants.RESET_BTN_TXT,t?e===FINAL_POMO?(e=0,pomoCount=0,pomoState=Constants.timerOptions.LONG,beginCountdown(Constants.LONG_BREAK)):(e++,pomoState=Constants.timerOptions.SHORT,beginCountdown(Constants.SHORT_BREAK)):(pomoState=Constants.timerOptions.POMO,beginCountdown(Constants.WORK_LENGTH))),[pomoState,e]}function stopTimer(){pomoState=Constants.timerOptions.STOPPED,timerAudio.play(),timerRing.setAttribute("stroke",STOP_TIMER_COLOR),countdownText.classList.remove(HOVER_TEXT),startStopButton.innerHTML=Constants.BEGIN_BTN_TXT,onBreak?(displayTime(Constants.WORK_LENGTH),timerTypeIndicator(Constants.timerOptions.POMO)):(++pomoCount===Constants.POMO_CYCLE_LENGTH?(displayTime(Constants.LONG_BREAK),timerTypeIndicator(Constants.timerOptions.LONG)):(displayTime(Constants.SHORT_BREAK),timerTypeIndicator(Constants.timerOptions.SHORT)),Storage.incrPomoCount(),increaseTaskPomo(),updateStats()),updatePots(),toggleTaskButtonDisabled(!1),onBreak=togglePomoBreak(onBreak)}function updatePots(){for(let t=1;t<pomoCount+1;t++)document.getElementById("pot"+t).src=COLORED_POT_SOURCE;for(let t=pomoCount+1;t<=Constants.POMO_CYCLE_LENGTH;t++)document.getElementById("pot"+t).src=GRAY_POT_SOURCE}function resetTimer(){return pomoState=Constants.timerOptions.STOPPED,toggleTaskButtonDisabled(!0),startStopButton&&(startStopButton.innerHTML=Constants.BEGIN_BTN_TXT,timeWorker&&timeWorker.postMessage({start:!1}),legacyInterval&&clearInterval(legacyInterval),onBreak=onBreak&&togglePomoBreak(onBreak),countdownText.classList.remove(HOVER_TEXT),timerRing.setAttribute("stroke",STOP_TIMER_COLOR),timerRing.setAttribute("stroke-dasharray",DASH_STROKE_VAL+" "+DASH_STROKE_VAL),displayTime(Constants.WORK_LENGTH),timerTypeIndicator(Constants.WORK_LENGTH)),Storage.incrInterruptions(),updateStats(),[pomoState,Constants.BEGIN_BTN_TXT]}function resetPrompt(){firstReset?(startStopButton.style.display="none",document.getElementById("prompt").style.display="flex",yesButton.disabled=!1,noButton.disabled=!1,yesButton.addEventListener("click",()=>{resetConfirm(!0)}),noButton.addEventListener("click",()=>{resetConfirm(!1)})):resetTimer()}function hidePrompt(){startStopButton.style.display="",document.getElementById("prompt").style.display="none",yesButton.disabled=!0,noButton.disabled=!0}function resetConfirm(t){hidePrompt(),t&&resetTimer(),firstReset=!1}function displayTime(t){let e,o;return e=parseInt(t/MINUTES,BASE_10),o=parseInt(t%MINUTES,BASE_10),e=e<BASE_10?"0"+e:e,o=o<BASE_10?"0"+o:o,countdownText.textContent=e+":"+o,countdownText.textContent}function timeFraction(t,e){return e===Constants.timerOptions.POMO?t/Constants.WORK_LENGTH:e===Constants.timerOptions.LONG?t/Constants.LONG_BREAK:t/Constants.SHORT_BREAK}function timerTypeIndicator(t){workIndicator.classList.remove(HIGHLIGHT),longBreakIndicator.classList.remove(HIGHLIGHT),shortBreakIndicator.classList.remove(HIGHLIGHT),(t===Constants.timerOptions.LONG?longBreakIndicator:t===Constants.timerOptions.SHORT?shortBreakIndicator:workIndicator).classList.add(HIGHLIGHT)}startStopButton&&(startStopButton.classList.toggle(BREAK_BUTTON),startStopButton.addEventListener("click",startResetController)),countdownText&&countdownText.addEventListener("click",()=>{pomoState!==Constants.timerOptions.STOPPED&&(countdownText.classList.contains(HOVER_TEXT)?countdownText.classList.remove(HOVER_TEXT):countdownText.classList.add(HOVER_TEXT))});export{startResetController,beginCountdown,setCountdownInterval,togglePomoBreak,startTimer,updatePots,resetTimer,resetPrompt,hidePrompt,resetConfirm,displayTime,timeFraction,timerTypeIndicator};